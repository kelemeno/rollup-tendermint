package consensus

import (
	"encoding/json"
	"math/big"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/tendermint/tendermint/types"
)

func TestFormatSignedHeader(t *testing.T) {
	lightBlockString := `{"signed_header":{"header":{"version":{"block":"11","app":"1"},"chain_id":"test-chain-IrF74Y","height":"2","time":"2022-10-14T11:06:35.413940948Z","last_block_id":{"hash":"01F491396B02D56397E056A39D7EF263DF45254F89C40B17B28CFB6FB7CCFD2E","parts":{"total":1,"hash":"0740C1781E703EF4BE74626BB920F569D5CE37200C2DC91226D0D0099E52AC09"}},"last_commit_hash":"02E02E5672C11EC3A039ECFA9943FA2BB343A4A152BFFDA19DAA10F37B7541CD","data_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","validators_hash":"052C9B411FF6CF27281D4528BE392356B299E1BB94E78ED9F64936DB602E9AE3","next_validators_hash":"052C9B411FF6CF27281D4528BE392356B299E1BB94E78ED9F64936DB602E9AE3","consensus_hash":"04B6EE42C4CB17A4129A2B6135C8FB4B6CBA7A5F9A18B87C4EFEFB74F2F0F24E","app_hash":"0000000000000000000000000000000000000000000000000000000000000000","last_results_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","evidence_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","proposer_address":"07505C4FCAD35561F9118A049D9C97CB01C2F60D845BDBE25639BB1706EA0275"},"commit":{"height":"2","round":0,"block_id":{"hash":"01F94F4D5BCFBE0DDAB054594502152C52360597273194CEE5ADB579311EC87B","parts":{"total":1,"hash":"03B603B1874C195AE40D080CAEB3104142A0FCD9BE3E7A8FFC405353E408889E"}},"signatures":[{"block_id_flag":2,"validator_address":"07505C4FCAD35561F9118A049D9C97CB01C2F60D845BDBE25639BB1706EA0275","timestamp":"2022-10-14T11:06:40.929141572Z","signature":"BCKoIfq1Fxpa/I2De9PhoN592+Bj3zVSKHMiUTD6mEAFbWctuH8wILbzsT4l4SGVsI4VxbGWL1fT/1Oek/qZCA=="}]}},"canonical":true}`
	expected := `{"header":{"consensus_data":{"block":11,"app":1},"height":2,"time":{"nanos":1665745595413940948},"last_block_id":{"hash":884425833596017687902070213747808739115022713891866619587347960517452692782,"part_set_header":{"total":1,"hash":3280603427672755996697561151661387289552035726080851369010608355561641782281}},"last_commit_hash":1300719250649302888673721710201729934164570534884866772308748105278349984205,"data_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"validators_hash":2340377040213079208513181851626792215421593955873165280879009333623007386339,"next_validators_hash":2340377040213079208513181851626792215421593955873165280879009333623007386339,"consensus_hash":2132461975834504200398180281070409533541683498016798668455504133351250391630,"app_hash":0,"last_results_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"evidence_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"proposer_address":3308174817124847388915938526006361282230966751698668845121616562821790302837},"commit":{"height":2,"round":0,"block_id":{"hash":892805091259252719451078399408285323788861340980283502742818584651789944955,"part_set_header":{"total":1,"hash":1678530202937530276285116262009511904790607301550138088769956212479453857950}}}}`

	var lightBlock types.LightBlock
	json.Unmarshal([]byte(lightBlockString), &lightBlock)

	res := FormatSignedHeader(*lightBlock.SignedHeader)

	resLightBlock, _ := json.Marshal(res)
	resLightBlockString := string(resLightBlock)

	assert.Equal(t, expected, resLightBlockString)
}

func TestFormatValidatorSet(t *testing.T) {
	validatorsString := `{"block_height":"3","validators":[{"address":"07505C4FCAD35561F9118A049D9C97CB01C2F60D845BDBE25639BB1706EA0275","pub_key":{"type":"tendermint/PubKeyStark","value":"BCSyZuiwaiVNC0tMTPQrXGoZQpYImwdyV3K88ltKu7EC2JFryijF/Td9JaXiEVWqpwsSwllhhrY8lJDBmwt2BA=="},"voting_power":"10","proposer_priority":"0"}],"count":"1","total":"1"}`
	expected := `{"proposer":{"Address":3308174817124847388915938526006361282230966751698668845121616562821790302837,"pub_key":{"ecdsa":1874089173934400596279690104790724610118670100261327038271526874663074053041},"voting_power":10,"proposer_priority":0},"total_voting_power":10}`

	var validators types.ValidatorSet
	json.Unmarshal([]byte(validatorsString), &validators)

	validators.Proposer = validators.Validators[0]

	res := FormatValidatorSet(&validators)

	resLightBlock, _ := json.Marshal(res)
	resLightBlockString := string(resLightBlock)

	assert.Equal(t, expected, resLightBlockString)
}

func TestFormatValidator(t *testing.T) {
	trustedLightBlockString := `{"signed_header":{"header":{"version":{"block":"11","app":"1"},"chain_id":"test-chain-IrF74Y","height":"2","time":"2022-11-04T17:43:45.220479Z","last_block_id":{"hash":"038E1EFB6F2C0B4AA1051C0A9B4494B0A7CF34D81C76E6C161B164249A660ABF","parts":{"total":1,"hash":"06A9F404CEC26739C0E7FBDC46DAC64B9151D3A14FA4BB8B4DFD1785D3B14C15"}},"last_commit_hash":"06BE053E669912201CFE99C43884AB9AC38713AC888873B375588A4C401428F6","data_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","validators_hash":"0241C0593DCFA3154B864E19E3AB6C03D2B79181BE7DC6565C9B6C68EA4D47F6","next_validators_hash":"0241C0593DCFA3154B864E19E3AB6C03D2B79181BE7DC6565C9B6C68EA4D47F6","consensus_hash":"00848270D575B49884653D7B3ED720EB84CE99D064D3BD3210FE23BFB811CB66","app_hash":"0000000000000000000000000000000000000000000000000000000000000000","last_results_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","evidence_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","proposer_address":"06EBC607235127FDABA1DB1A9CE71A34E7B880084F7188B03E7A3A1F0334DDBD"},"commit":{"height":"2","round":0,"block_id":{"hash":"048A972F4E947BBBF4E9E0AF350AD233EC6E394903728B3D3F8488F168915C16","parts":{"total":1,"hash":"04A7BCD4D5AEED5C99B3530549E83C7DACA49102542B20E28C48FBD0E911A622"}},"signatures":[{"block_id_flag":2,"validator_address":"06EBC607235127FDABA1DB1A9CE71A34E7B880084F7188B03E7A3A1F0334DDBD","timestamp":"2022-11-04T17:43:46.755686Z","signature":"BWkRvub8iP9VltjYMrfDekOL/0WjijYEIUjbkVnSntQDMU0B4izOLRPcJqub0t0AHyDPCOvx+4w14gdeKSxfmQ=="}]}},"canonical":false}`
	untrustedLightBlockString := `{"signed_header":{"header":{"version":{"block":"11","app":"1"},"chain_id":"test-chain-IrF74Y","height":"3","time":"2022-11-04T17:43:48.879554Z","last_block_id":{"hash":"048A972F4E947BBBF4E9E0AF350AD233EC6E394903728B3D3F8488F168915C16","parts":{"total":1,"hash":"04A7BCD4D5AEED5C99B3530549E83C7DACA49102542B20E28C48FBD0E911A622"}},"last_commit_hash":"03DEA59253B9502F1AEDEA3A4FADFFB57C3229266AA8601BCEC23BA292D5A347","data_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","validators_hash":"0241C0593DCFA3154B864E19E3AB6C03D2B79181BE7DC6565C9B6C68EA4D47F6","next_validators_hash":"0241C0593DCFA3154B864E19E3AB6C03D2B79181BE7DC6565C9B6C68EA4D47F6","consensus_hash":"00848270D575B49884653D7B3ED720EB84CE99D064D3BD3210FE23BFB811CB66","app_hash":"0000000000000000000000000000000000000000000000000000000000000000","last_results_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","evidence_hash":"049EE3EBA8C1600700EE1B87EB599F16716B0B1022947733551FDE4050CA6804","proposer_address":"06EBC607235127FDABA1DB1A9CE71A34E7B880084F7188B03E7A3A1F0334DDBD"},"commit":{"height":"3","round":0,"block_id":{"hash":"03054DF71090EE602E6C0A433B949B726DC20719BD8448E281679A4F78810B7B","parts":{"total":1,"hash":"0424FD36683BB2F85C88BF098088937769FD788C422E63D66714F939F7E77FB9"}},"signatures":[{"block_id_flag":2,"validator_address":"06EBC607235127FDABA1DB1A9CE71A34E7B880084F7188B03E7A3A1F0334DDBD","timestamp":"2022-11-04T17:43:50.41826Z","signature":"BC6w1ASm4R4jq2or6mjD2ROgaYr4WcAT2GskhCOcPQIGXVoVV7JfLXnRsQEaPSjmtjr4ZIOt06InimmziDjqTw=="}]}},"canonical":true}`
	validatorSetString := `{"block_height":"3","validators":[{"address":"06EBC607235127FDABA1DB1A9CE71A34E7B880084F7188B03E7A3A1F0334DDBD","pub_key":{"type":"tendermint/PubKeyStark","value":"AHzA3ABEpcfPL3+Zfmdm4fGb1MBih2zMt0m1iyqS5KsAoJVUlan320a55nvQrj1ilGjRDSPZqeaLyKbEe6KT3g=="},"voting_power":"10","proposer_priority":"0"}],"count":"1","total":"1"}`
	expected := `{"chain_id_array":[116,134851498068554549348179021563090646105],"trusted_commit_sig_array":[{"block_id_flag":{"BlockIDFlag":2},"validator_address":3130452889938125787960542141088922762320907741934170438635049009044201463229,"timestamp":{"nanos":1667583826755686000},"signature":{"signature_r":2447205661121538511891807296011110970209529191929629105427514220004378844884,"signature_s":1444045537171599317249944159970389880907024599059570970802634884335679594393}}],"untrusted_commit_sig_array":[{"block_id_flag":{"BlockIDFlag":2},"validator_address":3130452889938125787960542141088922762320907741934170438635049009044201463229,"timestamp":{"nanos":1667583830418260000},"signature":{"signature_r":1891746782668499163867038216656548348033350424615118832289530842088245837058,"signature_s":2878815601089626506331543868109122964793498038700927463755427544208911166031}}],"validator_array":[{"Address":3130452889938125787960542141088922762320907741934170438635049009044201463229,"pub_key":{"ecdsa":220420102547610194731454445694308769904232505829525221053925466434463524011},"voting_power":10,"proposer_priority":0}],"trusted":{"header":{"consensus_data":{"block":11,"app":1},"height":2,"time":{"nanos":1667583825220479000},"last_block_id":{"hash":1608044659993129981757606396884950244923617306676871283149981715145318337215,"part_set_header":{"total":1,"hash":3014158401169853780002477981815284661624277810416880823282317418208504663061}},"last_commit_hash":3049614224860742094992741197807612949922798771766979038554064366911024802038,"data_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"validators_hash":1020798297620431640019261836504109989334917827376324471954229313849864833014,"next_validators_hash":1020798297620431640019261836504109989334917827376324471954229313849864833014,"consensus_hash":234124081569795565587102694823995504121944889231325624732957112998326029158,"app_hash":0,"last_results_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"evidence_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"proposer_address":3130452889938125787960542141088922762320907741934170438635049009044201463229},"commit":{"height":2,"round":0,"block_id":{"hash":2054119728363782574158841874728503829158541544464718554910669238611003661334,"part_set_header":{"total":1,"hash":2105618120476424797686108732273703874470826528681376345443856808126578796066}}}},"untrusted":{"header":{"consensus_data":{"block":11,"app":1},"height":3,"time":{"nanos":1667583828879554000},"last_block_id":{"hash":2054119728363782574158841874728503829158541544464718554910669238611003661334,"part_set_header":{"total":1,"hash":2105618120476424797686108732273703874470826528681376345443856808126578796066}},"last_commit_hash":1750321327247187978299781709825224579018176929700146288150402017879286719303,"data_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"validators_hash":1020798297620431640019261836504109989334917827376324471954229313849864833014,"next_validators_hash":1020798297620431640019261836504109989334917827376324471954229313849864833014,"consensus_hash":234124081569795565587102694823995504121944889231325624732957112998326029158,"app_hash":0,"last_results_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"evidence_hash":2089986280348253421170679821480865132823066470938446095505822317253594081284,"proposer_address":3130452889938125787960542141088922762320907741934170438635049009044201463229},"commit":{"height":3,"round":0,"block_id":{"hash":1366310876393838632142594271202682211205833528590660182434111798418132241275,"part_set_header":{"total":1,"hash":1874605497304982547843540061633919677109036817986024418804765509406532534201}}}},"validator_set_args":{"proposer":{"Address":3130452889938125787960542141088922762320907741934170438635049009044201463229,"pub_key":{"ecdsa":220420102547610194731454445694308769904232505829525221053925466434463524011},"voting_power":10,"proposer_priority":0},"total_voting_power":10},"verification_args":{"current_time":{"nanos":1665753884507526850},"max_clock_drift":{"nanos":10},"trusting_period":{"nanos":99999999999999999999}}}`

	var validatorSet types.ValidatorSet
	json.Unmarshal([]byte(validatorSetString), &validatorSet)
	validatorSet.Proposer = validatorSet.Validators[0]

	var trustedLightBlock, untrustedLightBlock types.LightBlock
	json.Unmarshal([]byte(trustedLightBlockString), &trustedLightBlock)
	json.Unmarshal([]byte(untrustedLightBlockString), &untrustedLightBlock)

	trustingPeriod, _ := big.NewInt(0).SetString("99999999999999999999", 10)

	res := FormatCallData(trustedLightBlock, untrustedLightBlock, &validatorSet, big.NewInt(1665753884507526850), big.NewInt(10), trustingPeriod)

	resExternal, _ := json.Marshal(res)
	resExternalString := string(resExternal)

	assert.Equal(t, expected, resExternalString)
}
